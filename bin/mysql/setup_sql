#! /usr/bin/ksh

# temporary file, to be removed before shipping!!!

#
# Setup script for database-related benchmarks
# 
# Copyright (c) 2019 Till Miemietz
#

# if the script is not executed by root, abort it
if [ `id -u` -ne 0 ]
  then
  echo "This script has to be executed with root privileges!"
  exit 1
fi

# first shut down and disable app armor
echo "Disabling app armor..."
systemctl stop apparmor.service
systemctl disable apparmor.service
echo "Done..."

# reset sql data directory (will shut down running MySQL instances)
echo "Setting SQL data directory..."
systemctl stop mysqld.service
systemctl disable mysql.service
CONFIG=`cat /etc/mysql/mysql.conf.d/mysqld.cnf | awk '
        { gsub("/var/lib/mysql", "/mnt/sql"); print($0); }
    '`
echo "$CONFIG" > /etc/mysql/mysql.conf.d/mysqld.cnf
echo "Done..."

# set io priority of SQL daemon 
# in default config, no ioprio is set for the mysql service, so we can simply
# append some lines to the systemd config file. if there is an error while
# starting the mysql service, add the lines below manually to the daemon config
echo "Setting systemd I/O priority..."
echo "IOSchedulingClass=1" >> /lib/systemd/system/mysql.service
echo "IOSchedulingPrio=0" >> /lib/systemd/system/mysql.service
echo "Done..."
echo "Reloading daemon configuration..."
systemctl daemon-reload
echo "Done..."
