#! /usr/bin/ksh

# temporary file, to be removed for shipping!!!

echo "Enter root's password:"
stty -echo
read ROOTPW
stty echo

sudo apt-get -q -y install build-essential
sudo apt-get -q -y install ncurses-dev
sudo apt-get -q -y install libelf-dev
sudo apt-get -q -y install libssl-dev
sudo apt-get -q -y install autoconf
sudo apt-get -q -y install pkg-config
sudo apt-get -q -y install libtool-bin
sudo apt-get -q -y install bison
sudo apt-get -q -y install flex
sudo apt-get -q -y install libpopt-dev
sudo apt-get -q -y install libxml2-dev
sudo apt-get -q -y install uuid-dev
sudo apt-get -q -y install liburcu-dev
sudo apt-get -q -y install swig
sudo apt-get -q -y install python3-dev
sudo apt-get -q -y install asciidoc xmlto
sudo apt-get -q -y install babeltrace
sudo apt-get -q -y install python3-babeltrace
sudo apt-get -q -y install fio
sudo apt-get -q -y install mysql-server
sudo apt-get -q -y install libaio-dev
sudo apt-get -q -y install libmysqlclient-dev
sudo apt-get -q -y install r-base

sudo Rscript -e "install.packages(\"reshape2\")"
sudo Rscript -e "install.packages(\"data.table\")"
sudo Rscript -e "install.packages(\"dplyr\")"

mkdir ~/k2-src
mkdir ~/k2-results
cd ~/k2-src

git clone https://github.com/TUD-OS/k2-linux --depth 1 # do not consume the whole linux repo
git clone https://github.com/TUD-OS/k2-scheduler
git clone https://github.com/TUD-OS/k2-lttng-modules
git clone https://github.com/lttng/lttng-tools
git clone https://github.com/akopytov/sysbench

cd k2-linux/
# maybe consider: /boot/config4.15.20-generic...
cp -v /boot/config-$(uname -r) .config
# make allmodconfig
make -j 4
sudo make modules_install -j 4
sudo make install -j 4

MENUID=`cat /boot/grub/grub.cfg | grep "submenu" | cut -d' ' -f7 | tr -d "'"`
NKERNEL=`cat /boot/grub/grub.cfg | grep "'Ubuntu, with Linux 4.15.0-k2+'" | cut -d' ' -f15 | tr -d "'"`
GRUBCONF=`cat /etc/default/grub | awk -v krn="$NKERNEL" -v men="$MENUID" '
    { gsub("GRUB_CMDLINE_LINUX=\"\"", "GRUB_CMDLINE_LINUX=\"scsi_mod.use_blk_mq=1\""); 
      gsub("\"quiet splash\"", "\"\""); 
      gsub("GRUB_DEFAULT=0", "GRUB_DEFAULT=\"" men ">" krn "\""); 
      print($0); }
'`

# echo $MENUID
# echo $NKERNEL
echo "$GRUBCONF" > /etc/default/grub

sudo update-grub
sudo /bin/sh -c "echo bfq >> /etc/modules"
sudo /bin/sh -c "echo kyber-iosched >> /etc/modules"
sudo /bin/sh -c "echo mq-deadline >> /etc/modules"

# first shut down and disable app armor
echo "Disabling app armor..."
systemctl stop apparmor.service
systemctl disable apparmor.service
echo "Done..."

# reset sql data directory (will shut down running MySQL instances)
echo "Setting SQL data directory..."
systemctl stop mysqld.service
systemctl disable mysql.service
CONFIG=`cat /etc/mysql/mysql.conf.d/mysqld.cnf | awk '
        { gsub("/var/lib/mysql", "/mnt/sql"); print($0); }
    '`
echo "$CONFIG" > /etc/mysql/mysql.conf.d/mysqld.cnf
echo "Done..."

# set io priority of SQL daemon 
# in default config, no ioprio is set for the mysql service, so we can simply
# append some lines to the systemd config file. if there is an error while
# starting the mysql service, add the lines below manually to the daemon config
echo "Setting systemd I/O priority..."
echo "IOSchedulingClass=1" >> /lib/systemd/system/mysql.service
echo "IOSchedulingPrio=0" >> /lib/systemd/system/mysql.service
echo "Done..."
echo "Reloading daemon configuration..."
systemctl daemon-reload
echo "Done..."

<reboot>

cd ~/k2-src/k2-scheduler/
make
make install

cd ~/k2-src/k2-lttng-modules/
make -j 4
sudo make modules_install -j 4
sudo depmod -a
cd ~/k2-src/lttng-tools/
./bootstrap
./configure --enable-python-bindings --without-lttng-ust
make -j 4
sudo make install -j 4
sudo ldconfig
cd ~/k2-src/sysbench
git checkout 1.0.16
./autogeh.sh
./configure
make -j 4
sudo make install

cd ~
ruby k2-benchmarks/postproc/scripts/extract_fg_bw.rb # creates fg_bw.dat files
mkdir -p k2-results/generated/data
touch k2-results/generated/data/mb
touch k2-results/generated/data/ml
Rscript  k2-benchmarks/postproc/scripts/postprocess_k2.R

